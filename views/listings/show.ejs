<% layout("layouts/boilerplate") %>

<div class="container mt-4">
  <!-- Back Button Top-Left -->
  <div class="mb-3">
    <a href="/listings" class="btn btn-outline-secondary back-btn">
      <i class="fa-solid fa-arrow-left me-1"></i> Back to Listings
    </a>
  </div>

  <!-- Main Content -->
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <!-- Listing Card -->
      <div class="card rounded-4">
        <h4 class="card-title mb-3"><strong><%= listing.title %></strong></h4>
        <img
          loading="lazy"
          src="<%= listing.image.url %>"
          class="show-card-img-top rounded-top-4"
          alt="<%= listing.title %>"
        />
        <div class="card-body">
          <p class="card-text">
            Owned by: <i><%= listing.owner.username %></i>
          </p>
          <p class="card-text text-muted"><%= listing.description %></p>
          <hr />
          <p class="card-text">
            <strong>Price:</strong> â‚¹<%= listing.price.toLocaleString("en-IN")
            %><br />
            <strong>Location:</strong> <%= listing.location %>, <%=
            listing.country %>
          </p>
        </div>
      </div>
      <% if(currentUser && currentUser._id.equals(listing.owner._id)) { %>
      <!-- Actions -->
      <div class="mt-3 d-flex justify-content-between gap-2">
        <a href="/listings/<%= listing.id %>/edit" class="btn btn-primary w-100"
          >Edit Listing</a
        >
        <form
          action="/listings/<%= listing.id %>?_method=DELETE"
          method="POST"
          class="w-100"
        >
          <button type="submit" class="btn btn-danger w-100">
            Delete Listing
          </button>
        </form>
      </div>
      <% } %>

      <!--Create Review Section-->
      <% if(currentUser) { %>
      <div class="review-section">
        <hr />
        <h4>Leave a review</h4>
        <form
          action="/listings/<%= listing.id %>/reviews"
          method="POST"
          class="needs-validation"
          novalidate
        >
          <div class="mb-3 col-4">
            <label class="form-label" for="rating">Rating:</label>
            <input
              type="range"
              id="rating"
              name="review[rating]"
              min="1"
              max="5"
              class="form-range form-control"
            />
          </div>
          <div class="mb-3">
            <label class="form-label" for="comment">Comment:</label>
            <textarea
              id="comment"
              name="review[comment]"
              class="form-control"
              rows="5"
              placeholder="Write your review here..."
              required
            ></textarea>
            <div class="invalid-feedback">Please provide a comment</div>
          </div>
          <div class="mt-3">
            <button type="submit" class="btn btn-primary add-btn">
              Submit Review
            </button>
          </div>
        </form>
      </div>
      <% } %> <% if(listing.reviews.length > 0) { %>
      <hr />
      <h4 class="mt-4 mb-3">All Reviews</h4>
      <div class="list-group">
  <% for (let review of listing.reviews) { %>
    <div class="list-group-item mb-4 py-4 px-3 px-md-4 border-0 border-bottom shadow-sm rounded-3 bg-light-subtle">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <!-- Reviewer Info -->
        <div class="d-flex align-items-center gap-3">
          <div class="bg-secondary-subtle rounded-circle d-flex align-items-center justify-content-center" style="width: 42px; height: 42px;">
            <i class="bi bi-person-fill fs-5 text-dark"></i>
          </div>
          <div class="fw-semibold fs-6">
            <%= review.author?.username || "Anonymous" %>
          </div>
        </div>

        <!-- Star Rating -->
        <div class="d-flex align-items-center gap-1 text-warning fs-6">
          <% for(let i = 1; i <= 5; i++) { %>
            <i class="bi <%= i <= review.rating ? 'bi-star-fill' : 'bi-star' %>"></i>
          <% } %>
        </div>
      </div>

      <!-- Review Comment -->
      <p class="text-body-secondary mb-3 fs-6"><%= review.comment %></p>

      <!-- Delete Button (if owner) -->
      <% if (currentUser && currentUser._id.equals(review.author._id)) { %>
        <form
          action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
          method="POST"
        >
          <button type="submit" class="btn btn-outline-danger btn-sm rounded-pill px-3">
            <i class="bi bi-trash3 me-1"></i> Delete
          </button>
        </form>
      <% } %>
    </div>
  <% } %>
</div>


      <% } %>
    </div>
  </div>
</div>
